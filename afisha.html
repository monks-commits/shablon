<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Афіша — Театральні квитки онлайн</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>

  <!-- Шапка -->
  <div id="site-header"></div>
  <script type="module" src="/scripts/include.js"></script>

  <main class="main">

    <!-- Заголовок сторінки -->
    <section class="page-header">
      <div class="container page-header__inner">
        <h1 class="page-title">Афіша</h1>
        <p class="page-subtitle">
          Оберіть виставу та забронюйте квитки онлайн за ціною каси театру.
        </p>
      </div>
    </section>

    <!-- Фільтри + список подій -->
    <section class="section">
      <div class="container">

        <!-- Фільтри по містах (формуються з даних) -->
        <div id="filters" class="filters">
          <button class="pill pill--active" data-city="all">Всі міста</button>
        </div>

        <!-- Сітка подій -->
        <div id="grid" class="grid-events"></div>

        <!-- Повідомлення "порожньо" -->
        <p id="empty" class="meta meta--empty" style="display:none">
          Подій за вибраним фільтром поки немає.
        </p>

      </div>
    </section>

  </main>

  <!-- Підвал -->
  <div id="site-footer"></div>

  <script>
  (async () => {
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const filters = document.getElementById('filters');

    let items = [];
    try {
      const res = await fetch('/data/afisha.json', { cache: 'no-store' });
      items = res.ok ? await res.json() : [];
    } catch (e) {
      items = [];
    }

    // Унікальні міста з афіші
    const cities = Array.from(
      new Set(
        items
          .map(x => (x.city || '').trim())
          .filter(Boolean)
      )
    );

    // Додаємо кнопки по містах
    cities.forEach(city => {
      const btn = document.createElement('button');
      btn.className = 'pill';
      btn.dataset.city = city;
      btn.textContent = city;
      filters.appendChild(btn);
    });

    function cardHTML(s) {
      const poster = s.poster ? '/' + s.poster.replace(/^\/+/, '') : '';
      const show = encodeURIComponent(s.show);
      const dateTime = [s.date, s.time].filter(Boolean).join(' • ');
      const place = [s.theatre, s.stage].filter(Boolean).join(' • ');
      const city = s.city || '';

      return `
        <article class="card event-card">
          ${poster ? `
            <img
              class="event-card__poster"
              src="${poster}"
              alt="${s.title || ''}"
              onerror="this.style.display='none'"
            >
          ` : ''}
          <div class="event-card__body">
            <h2 class="event-card__title">${s.title || ''}</h2>
            ${dateTime ? `<p class="meta event-card__meta">${dateTime}</p>` : ''}
            ${place ? `<p class="meta event-card__meta">${place}</p>` : ''}
            ${city ? `<p class="meta event-card__meta">${city}</p>` : ''}
            <div class="event-card__actions">
              <a class="btn btn--secondary" href="/show.html?show=${show}">Детальніше</a>
              <a class="btn btn--primary" href="/spectacles/hall.html?show=${show}">Вибрати місця</a>
            </div>
          </div>
        </article>
      `;
    }

    function render(city = 'all') {
      const data = city === 'all'
        ? items
        : items.filter(x => (x.city || '').toLowerCase() === city.toLowerCase());

      grid.innerHTML = data.map(cardHTML).join('');
      empty.style.display = data.length ? 'none' : 'block';
    }

    function setActive(city) {
      const buttons = filters.querySelectorAll('.pill');
      buttons.forEach(b => {
        b.classList.toggle(
          'pill--active',
          b.dataset.city === city || (city === 'all' && b.dataset.city === 'all')
        );
      });
    }

    // Клік по фільтрам
    filters.addEventListener('click', (e) => {
      if (e.target.matches('.pill')) {
        const city = e.target.dataset.city;
        setActive(city);
        render(city);
      }
    });

    // ?city=... у рядку адреси
    const q = new URLSearchParams(location.search);
    const c = q.get('city');
    if (c && cities.includes(c)) {
      setActive(c);
      render(c);
    } else {
      setActive('all');
      render('all');
    }
  })();
  </script>

</body>
</html>
